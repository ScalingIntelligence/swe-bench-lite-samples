{
  "info": {
    "duration": 224.70254850387573,
    "submission": "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 7649c39262..687b773587 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -353,7 +353,8 @@ class SQLCompiler:\n             # not taken into account so we strip it. When this entire method\n             # is refactored into expressions, then we can check each part as we\n             # generate it.\n-            without_ordering = self.ordering_parts.search(sql).group(1)\n+            sql_oneline = ' '.join(sql.split('\\n'))\n+            without_ordering = self.ordering_parts.search(sql_oneline).group(1)\n             params_hash = make_hashable(params)\n             if (without_ordering, params_hash) in seen:\n                 continue\n",
    "total_cost": 0.091413,
    "instance_id": "django__django-11001",
    "evaluation_name": "temperature_sweep_250_samples_50_problems_1.6"
  },
  "name": "AgenticLoop",
  "transitions": [
    {
      "name": "SearchCode",
      "state": {
        "model": "deepseek-coder",
        "message": null,
        "max_tokens": 1000,
        "temperature": 1.6,
        "max_iterations": null,
        "max_search_results": 25,
        "support_test_files": false,
        "initial_context_tokens": 4000,
        "initial_search_results": 50,
        "include_message_history": true,
        "provide_initial_context": true,
        "initial_context_spans_per_file": 5,
        "max_retries_with_any_file_context": 3
      },
      "actions": [
        {
          "action": {
            "complete": false,
            "scratch_pad": "The issue described involves the incorrect removal of the 'order by' clause in multiline RawSQL statements, particularly occurring in the SQLCompiler.get_order_by() method. The problem is that the SQLCompiler is identifying duplicate 'order by' clauses based on the last line of the SQL passed, which is incorrect. This can be addressed by ensuring that the SQL is processed as a single line, avoiding the misinterpretation of newline characters. Given the context, it is crucial to focus the search on the SQLCompiler class within the django/db/models/sql/compiler.py file, as this is where the get_order_by method is defined. Additionally, examining the expressions.py file for any relevant handling of RawSQL and OrderBy classes can be beneficial.",
            "search_requests": [
              {
                "query": "get_order_by incorrect removal of order by clause",
                "class_names": [
                  "SQLCompiler"
                ],
                "code_snippet": null,
                "file_pattern": "**/django/db/models/sql/compiler.py",
                "function_names": []
              },
              {
                "query": null,
                "class_names": [
                  "RawSQL",
                  "OrderBy"
                ],
                "code_snippet": null,
                "file_pattern": "**/django/db/models/expressions.py",
                "function_names": []
              }
            ]
          },
          "output": {
            "complete": false,
            "ranked_spans": [
              {
                "rank": 0,
                "tokens": 105,
                "span_id": "SQLCompiler.get_extra_select",
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "rank": 1,
                "tokens": 839,
                "span_id": "SQLCompiler.get_order_by",
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "rank": 3,
                "tokens": 735,
                "span_id": "SQLCompiler.get_group_by",
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "rank": 4,
                "tokens": 138,
                "span_id": "SQLCompiler._setup_joins",
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "rank": 6,
                "tokens": 4,
                "span_id": "SQLCompiler",
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "rank": 6,
                "tokens": 56,
                "span_id": "SQLCompiler.setup_query",
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "rank": 7,
                "tokens": 126,
                "span_id": "SQLCompiler.pre_sql_setup",
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "rank": 8,
                "tokens": 459,
                "span_id": "SQLCompiler.collapse_group_by",
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "rank": 9,
                "tokens": 324,
                "span_id": "SQLCompiler.find_ordering_name",
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "rank": 10,
                "tokens": 165,
                "span_id": "SQLCompiler.get_distinct",
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "rank": 11,
                "tokens": 1358,
                "span_id": "SQLCompiler.as_sql",
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "rank": 13,
                "tokens": 303,
                "span_id": "SQLCompiler.get_from_clause",
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "rank": 14,
                "tokens": 491,
                "span_id": "SQLCompiler.get_combinator_sql",
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "rank": 0,
                "tokens": 5,
                "span_id": "RawSQL",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 44,
                "span_id": "RawSQL.__init__",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 25,
                "span_id": "RawSQL.__repr__",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 20,
                "span_id": "RawSQL.as_sql",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 13,
                "span_id": "RawSQL.get_group_by_cols",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 15,
                "span_id": "OrderBy",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 88,
                "span_id": "OrderBy.__init__",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 30,
                "span_id": "OrderBy.__repr__",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 18,
                "span_id": "OrderBy.set_source_expressions",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 11,
                "span_id": "OrderBy.get_source_expressions",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 126,
                "span_id": "OrderBy.as_sql",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 69,
                "span_id": "OrderBy.as_sqlite",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 81,
                "span_id": "OrderBy.as_mysql",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 32,
                "span_id": "OrderBy.get_group_by_cols",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 47,
                "span_id": "OrderBy.reverse_ordering",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 9,
                "span_id": "OrderBy.asc",
                "file_path": "django/db/models/expressions.py"
              },
              {
                "rank": 0,
                "tokens": 9,
                "span_id": "OrderBy.desc",
                "file_path": "django/db/models/expressions.py"
              }
            ],
            "search_requests": [
              {
                "query": "get_order_by incorrect removal of order by clause",
                "class_names": [
                  "SQLCompiler"
                ],
                "code_snippet": null,
                "file_pattern": "**/django/db/models/sql/compiler.py",
                "function_names": []
              },
              {
                "query": null,
                "class_names": [
                  "RawSQL",
                  "OrderBy"
                ],
                "code_snippet": null,
                "file_pattern": "**/django/db/models/expressions.py",
                "function_names": []
              }
            ]
          },
          "input_tokens": 3442,
          "output_tokens": 299,
          "retry_message": null,
          "completion_cost": 0.014811000000000001
        }
      ]
    },
    {
      "name": "IdentifyCode",
      "state": {
        "model": "deepseek-coder",
        "query": null,
        "class_name": null,
        "max_tokens": 1000,
        "temperature": 1.6,
        "code_snippet": null,
        "file_pattern": null,
        "ranked_spans": [
          {
            "rank": 0,
            "tokens": 105,
            "span_id": "SQLCompiler.get_extra_select",
            "file_path": "django/db/models/sql/compiler.py"
          },
          {
            "rank": 0,
            "tokens": 5,
            "span_id": "RawSQL",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 44,
            "span_id": "RawSQL.__init__",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 25,
            "span_id": "RawSQL.__repr__",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 20,
            "span_id": "RawSQL.as_sql",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 13,
            "span_id": "RawSQL.get_group_by_cols",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 15,
            "span_id": "OrderBy",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 88,
            "span_id": "OrderBy.__init__",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 30,
            "span_id": "OrderBy.__repr__",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 18,
            "span_id": "OrderBy.set_source_expressions",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 11,
            "span_id": "OrderBy.get_source_expressions",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 126,
            "span_id": "OrderBy.as_sql",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 69,
            "span_id": "OrderBy.as_sqlite",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 81,
            "span_id": "OrderBy.as_mysql",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 32,
            "span_id": "OrderBy.get_group_by_cols",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 47,
            "span_id": "OrderBy.reverse_ordering",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 9,
            "span_id": "OrderBy.asc",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 0,
            "tokens": 9,
            "span_id": "OrderBy.desc",
            "file_path": "django/db/models/expressions.py"
          },
          {
            "rank": 1,
            "tokens": 839,
            "span_id": "SQLCompiler.get_order_by",
            "file_path": "django/db/models/sql/compiler.py"
          },
          {
            "rank": 3,
            "tokens": 735,
            "span_id": "SQLCompiler.get_group_by",
            "file_path": "django/db/models/sql/compiler.py"
          },
          {
            "rank": 4,
            "tokens": 138,
            "span_id": "SQLCompiler._setup_joins",
            "file_path": "django/db/models/sql/compiler.py"
          },
          {
            "rank": 6,
            "tokens": 4,
            "span_id": "SQLCompiler",
            "file_path": "django/db/models/sql/compiler.py"
          },
          {
            "rank": 6,
            "tokens": 56,
            "span_id": "SQLCompiler.setup_query",
            "file_path": "django/db/models/sql/compiler.py"
          },
          {
            "rank": 7,
            "tokens": 126,
            "span_id": "SQLCompiler.pre_sql_setup",
            "file_path": "django/db/models/sql/compiler.py"
          },
          {
            "rank": 8,
            "tokens": 459,
            "span_id": "SQLCompiler.collapse_group_by",
            "file_path": "django/db/models/sql/compiler.py"
          },
          {
            "rank": 9,
            "tokens": 324,
            "span_id": "SQLCompiler.find_ordering_name",
            "file_path": "django/db/models/sql/compiler.py"
          },
          {
            "rank": 10,
            "tokens": 165,
            "span_id": "SQLCompiler.get_distinct",
            "file_path": "django/db/models/sql/compiler.py"
          },
          {
            "rank": 11,
            "tokens": 1358,
            "span_id": "SQLCompiler.as_sql",
            "file_path": "django/db/models/sql/compiler.py"
          },
          {
            "rank": 13,
            "tokens": 303,
            "span_id": "SQLCompiler.get_from_clause",
            "file_path": "django/db/models/sql/compiler.py"
          },
          {
            "rank": 14,
            "tokens": 491,
            "span_id": "SQLCompiler.get_combinator_sql",
            "file_path": "django/db/models/sql/compiler.py"
          }
        ],
        "function_name": null,
        "expand_context": true,
        "max_iterations": null,
        "max_prompt_file_tokens": 4000,
        "include_message_history": false
      },
      "actions": [
        {
          "action": {
            "scratch_pad": "Upon analyzing the reported issue, it's clear that the problem lies in the SQLCompiler's handling of the 'order by' clause when dealing with multiline RawSQL expressions. Specifically, the issue is that the SQLCompiler.get_order_by() method is incorrectly identifying duplicates due to the way it processes multiline SQL strings. The key to resolving this issue lies in how the SQLCompiler class handles the 'order by' clause, particularly in the get_order_by() method. The suggested fix involves converting the multiline SQL to a single line before processing, which is a reasonable approach to avoid issues with newline characters. Given this, the relevant sections of the code to focus on are the ones that deal with the 'order by' clause and the handling of RawSQL expressions. The SQLCompiler class in the django/db/models/sql/compiler.py file contains several methods such as get_order_by(), get_extra_select(), and setup_query() that are directly involved in processing the 'order by' clause. Additionally, the RawSQL class in the django/db/models/expressions.py file is relevant as it defines the behavior of RawSQL expressions used in the queries. By examining these sections, we can pinpoint the exact code spans that need to be modified or debugged to address the reported issue.",
            "identified_spans": [
              {
                "span_ids": [
                  "SQLCompiler.get_order_by"
                ],
                "file_path": "django/db/models/sql/compiler.py"
              },
              {
                "span_ids": [
                  "RawSQL.__init__"
                ],
                "file_path": "django/db/models/expressions.py"
              }
            ]
          },
          "output": {},
          "input_tokens": 4952,
          "output_tokens": 395,
          "retry_message": null,
          "completion_cost": 0.020781
        }
      ]
    },
    {
      "name": "DecideRelevance",
      "state": {
        "model": "deepseek-coder",
        "max_tokens": 1000,
        "temperature": 1.6,
        "expand_context": true,
        "max_iterations": null,
        "max_prompt_file_tokens": 4000,
        "include_message_history": false,
        "finish_after_relevant_count": 2
      },
      "actions": [
        {
          "action": {
            "complete": true,
            "relevant": true,
            "scratch_pad": "The file context includes the SQLCompiler class with the get_order_by method, which is specifically mentioned in the issue. This method is where the problem of incorrect removal of the 'order by' clause is occurring. Additionally, the RawSQL class is present in the expressions.py file, which is also relevant to the issue as it mentions handling of RawSQL and OrderBy classes. Given these points, it seems that the relevant code for addressing the issue is indeed provided in the file context.",
            "search_suggestions": null
          },
          "output": {},
          "input_tokens": 3056,
          "output_tokens": 139,
          "retry_message": null,
          "completion_cost": 0.011253
        }
      ]
    },
    {
      "name": "PlanToCode",
      "state": {
        "diff": null,
        "model": "deepseek-coder",
        "message": null,
        "max_tokens": 1000,
        "temperature": 1.6,
        "max_iterations": 8,
        "finish_on_review": false,
        "verification_errors": null,
        "max_prompt_file_tokens": 4000,
        "include_message_history": true,
        "allow_hallucinated_spans": false,
        "max_tokens_in_edit_prompt": 500,
        "expand_context_with_related_spans": true
      },
      "actions": [
        {
          "action": {
            "action": "modify",
            "finish": null,
            "reject": null,
            "span_id": "SQLCompiler.get_order_by",
            "file_path": "django/db/models/sql/compiler.py",
            "scratch_pad": "The issue involves the SQLCompiler's handling of multiline RawSQL in the 'order by' clause, where the current regular expression for identifying ordering parts is failing due to newline characters. To resolve this, we should normalize the SQL string by removing newline characters before applying the regular expression.",
            "instructions": "Update the SQLCompiler.get_order_by method to normalize the SQL string by converting newlines to spaces before applying the self.ordering_parts regular expression."
          },
          "output": {
            "span_id": "SQLCompiler.get_order_by",
            "file_path": "django/db/models/sql/compiler.py",
            "instructions": "Update the SQLCompiler.get_order_by method to normalize the SQL string by converting newlines to spaces before applying the self.ordering_parts regular expression."
          },
          "input_tokens": 3236,
          "output_tokens": 158,
          "retry_message": null,
          "completion_cost": 0.012078
        }
      ]
    },
    {
      "name": "ClarifyCodeChange",
      "state": {
        "model": "deepseek-coder",
        "span_id": "SQLCompiler.get_order_by",
        "end_line": null,
        "file_path": "django/db/models/sql/compiler.py",
        "max_tokens": 1000,
        "start_line": null,
        "temperature": 1.6,
        "instructions": "Update the SQLCompiler.get_order_by method to normalize the SQL string by converting newlines to spaces before applying the self.ordering_parts regular expression.\n\nThe get_order_by method needs to normalize the SQL string by converting newlines to spaces before applying the self.ordering_parts regular expression. This normalization should be applied to the SQL string generated for each resolved expression before the ordering parts are extracted and checked for duplicates.",
        "max_iterations": null,
        "include_message_history": false,
        "max_tokens_in_edit_prompt": 500
      },
      "actions": [
        {
          "action": {
            "reject": null,
            "end_line": 356,
            "start_line": 356,
            "scratch_pad": "The get_order_by method needs to normalize the SQL string by converting newlines to spaces before applying the self.ordering_parts regular expression. This normalization should be applied to the SQL string generated for each resolved expression before the ordering parts are extracted and checked for duplicates."
          },
          "output": {
            "span_id": "SQLCompiler.get_order_by",
            "end_line": 360,
            "file_path": "django/db/models/sql/compiler.py",
            "start_line": 352,
            "instructions": "Update the SQLCompiler.get_order_by method to normalize the SQL string by converting newlines to spaces before applying the self.ordering_parts regular expression.\n\nThe get_order_by method needs to normalize the SQL string by converting newlines to spaces before applying the self.ordering_parts regular expression. This normalization should be applied to the SQL string generated for each resolved expression before the ordering parts are extracted and checked for duplicates."
          },
          "input_tokens": 2033,
          "output_tokens": 94,
          "retry_message": null,
          "completion_cost": 0.007509
        }
      ]
    },
    {
      "name": "EditCode",
      "state": {
        "model": "deepseek-coder",
        "verify": true,
        "span_id": "SQLCompiler.get_order_by",
        "end_line": 360,
        "file_path": "django/db/models/sql/compiler.py",
        "max_tokens": 1000,
        "start_line": 352,
        "temperature": 1.6,
        "instructions": "Update the SQLCompiler.get_order_by method to normalize the SQL string by converting newlines to spaces before applying the self.ordering_parts regular expression.\n\nThe get_order_by method needs to normalize the SQL string by converting newlines to spaces before applying the self.ordering_parts regular expression. This normalization should be applied to the SQL string generated for each resolved expression before the ordering parts are extracted and checked for duplicates.",
        "max_iterations": 8,
        "chain_of_thought": false,
        "show_file_context": true,
        "show_initial_message": true,
        "max_prompt_file_tokens": 4000,
        "include_message_history": true
      },
      "actions": [
        {
          "action": {
            "content": "```xml\n<replace>\n            # Don't add the same column twice, but the order direction is\n            # not taken into account so we strip it. When this entire method\n            # is refactored into expressions, then we can check each part as we\n            # generate it.\n            sql_oneline = ' '.join(sql.split('\\n'))\n            without_ordering = self.ordering_parts.search(sql_oneline).group(1)\n            params_hash = make_hashable(params)\n            if (without_ordering, params_hash) in seen:\n                continue\n            seen.add((without_ordering, params_hash))\n</replace>"
          },
          "output": {
            "diff": "--- django/db/models/sql/compiler.py\n+++ django/db/models/sql/compiler.py\n@@ -353,7 +353,8 @@\n             # not taken into account so we strip it. When this entire method\n             # is refactored into expressions, then we can check each part as we\n             # generate it.\n-            without_ordering = self.ordering_parts.search(sql).group(1)\n+            sql_oneline = ' '.join(sql.split('\\n'))\n+            without_ordering = self.ordering_parts.search(sql_oneline).group(1)\n             params_hash = make_hashable(params)\n             if (without_ordering, params_hash) in seen:\n                 continue\n",
            "message": "Applied the change to django/db/models/sql/compiler.py.\n\n<scratch_pad>\n```xml\n</scratch_pad>",
            "verification_errors": []
          },
          "input_tokens": 3171,
          "output_tokens": 152,
          "retry_message": null,
          "completion_cost": 0.011793000000000001
        }
      ]
    },
    {
      "name": "PlanToCode",
      "state": {
        "diff": "--- django/db/models/sql/compiler.py\n+++ django/db/models/sql/compiler.py\n@@ -353,7 +353,8 @@\n             # not taken into account so we strip it. When this entire method\n             # is refactored into expressions, then we can check each part as we\n             # generate it.\n-            without_ordering = self.ordering_parts.search(sql).group(1)\n+            sql_oneline = ' '.join(sql.split('\\n'))\n+            without_ordering = self.ordering_parts.search(sql_oneline).group(1)\n             params_hash = make_hashable(params)\n             if (without_ordering, params_hash) in seen:\n                 continue\n",
        "model": "deepseek-coder",
        "message": "Applied the change to django/db/models/sql/compiler.py.\n\n<scratch_pad>\n```xml\n</scratch_pad>",
        "max_tokens": 1000,
        "temperature": 1.6,
        "max_iterations": 8,
        "finish_on_review": false,
        "verification_errors": [],
        "max_prompt_file_tokens": 4000,
        "include_message_history": true,
        "allow_hallucinated_spans": false,
        "max_tokens_in_edit_prompt": 500,
        "expand_context_with_related_spans": true
      },
      "actions": [
        {
          "action": {
            "action": "finish",
            "finish": "The changes have been successfully applied, resolving the issue of incorrect removal of order_by clauses in multiline RawSQL statements.",
            "reject": null,
            "span_id": null,
            "file_path": null,
            "scratch_pad": "The change was successfully applied. The SQLCompiler.get_order_by method now normalizes the SQL string by removing newline characters before applying the self.ordering_parts regular expression. This ensures that the regular expression correctly identifies the ordering parts without being misled by the newline characters within multiline RawSQL statements.",
            "instructions": null
          },
          "output": {
            "message": "The changes have been successfully applied, resolving the issue of incorrect removal of order_by clauses in multiline RawSQL statements."
          },
          "input_tokens": 3651,
          "output_tokens": 149,
          "retry_message": null,
          "completion_cost": 0.013188000000000002
        }
      ]
    },
    {
      "name": "Finished",
      "state": {
        "model": "gpt-4o",
        "output": {
          "model": "deepseek-coder",
          "temperature": 1.6
        },
        "message": "The changes have been successfully applied, resolving the issue of incorrect removal of order_by clauses in multiline RawSQL statements.",
        "max_tokens": 1000,
        "temperature": 0.0,
        "max_iterations": null,
        "include_message_history": false
      },
      "actions": []
    }
  ],
  "initial_message": "Incorrect removal of order_by clause created as multiline RawSQL\nDescription\n\t\nHi.\nThe SQLCompiler is ripping off one of my \"order by\" clause, because he \"thinks\" the clause was already \"seen\" (in SQLCompiler.get_order_by()). I'm using expressions written as multiline RawSQLs, which are similar but not the same. \nThe bug is located in SQLCompiler.get_order_by(), somewhere around line computing part of SQL query without ordering:\nwithout_ordering = self.ordering_parts.search(sql).group(1)\nThe sql variable contains multiline sql. As a result, the self.ordering_parts regular expression is returning just a line containing ASC or DESC words. This line is added to seen set, and because my raw queries have identical last lines, only the first clasue is returing from SQLCompiler.get_order_by().\nAs a quick/temporal fix I can suggest making sql variable clean of newline characters, like this:\nsql_oneline = ' '.join(sql.split('\\n'))\nwithout_ordering = self.ordering_parts.search(sql_oneline).group(1)\nNote: beware of unicode (Py2.x u'') and EOL dragons (\\r).\nExample of my query:\n\treturn MyModel.objects.all().order_by(\n\t\tRawSQL('''\n\t\t\tcase when status in ('accepted', 'verification')\n\t\t\t\t then 2 else 1 end''', []).desc(),\n\t\tRawSQL('''\n\t\t\tcase when status in ('accepted', 'verification')\n\t\t\t\t then (accepted_datetime, preferred_datetime)\n\t\t\t\t else null end''', []).asc(),\n\t\tRawSQL('''\n\t\t\tcase when status not in ('accepted', 'verification')\n\t\t\t\t then (accepted_datetime, preferred_datetime, created_at)\n\t\t\t\t else null end''', []).desc())\nThe ordering_parts.search is returing accordingly:\n'\t\t\t\t then 2 else 1 end)'\n'\t\t\t\t else null end'\n'\t\t\t\t else null end'\nSecond RawSQL with a\t\t\t\t else null end part is removed from query.\nThe fun thing is that the issue can be solved by workaround by adding a space or any other char to the last line. \nSo in case of RawSQL I can just say, that current implementation of avoiding duplicates in order by clause works only for special/rare cases (or does not work in all cases). \nThe bug filed here is about wrong identification of duplicates (because it compares only last line of SQL passed to order by clause).\nHope my notes will help you fixing the issue. Sorry for my english.\n"
}